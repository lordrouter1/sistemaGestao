<%- include("../includes/header.ejs",{title:title});%>

<%
let PJ;
let PF;
let MEI;
if(cliente != undefined){
    PJ = (cliente['classificacao']['pessoa']=='2')?'disabled':'';
    PF = (cliente['classificacao']['pessoa']=='2')?'':'disabled';
    MEI = (cliente['classificacao']['mei']=='1')?'disabled':'';
}else{
    cliente = {classificacao:{},endereco:{},contato:{}};
    PJ = "";
    PF = "disabled";
    MEI = "";
}
%>

<%-PJ-%>

<input type="hidden" id="inp_id" value="<%- cliente['_id'] -%>">

<form id="form_cadastro">
    <div class="card">
        <div class="card-header bg-primary text-light">
            <strong>Classificação</strong>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <label for="inp_pessoa">Tipo</label>
                    <select id="inp_pessoa" name="inp_pessoa" class="form-control">
                        <option value="1" <%- (cliente['classificacao']['pessoa'] != '2')?'selected':'' -%>>Pessoa Jurídica</option>
                        <option value="2" <%- (cliente['classificacao']['pessoa'] == '2')?'selected':'' -%>>Pessoa Física</option>
                    </select>
                </div>
                <div class="col">
                    <label for="inp_mei">MEI</label>
                    <select name="inp_mei" id="inp_mei" class="form-control" <%-PJ-%>>
                        <option value="0" <%- (cliente['classificacao']['mei'] != '1')?'selected':'' -%>>Não</option>
                        <option value="1" <%- (cliente['classificacao']['mei'] == '1')?'selected':'' -%>>Sim</option>
                    </select>
                </div>
                <div class="col">
                    <label for="inp_enquadramento">Enquadramento Fiscal</label>
                    <select name="inp_enquadramento" id="inp_enquadramento" class="form-control" <%-PJ-%> <%-MEI-%>>
                        <option value="1" <%- (cliente['classificacao']['enquadramento'] != '2' && cliente['classificacao']['enquadramento'] != '3')?'selected':'' -%>>Simples Nacional</option>
                        <option value="2" <%- (cliente['classificacao']['enquadramento'] == '2')?'selected':'' -%>>Lucro Presumido</option>
                        <option value="3" <%- (cliente['classificacao']['enquadramento'] == '3')?'selected':'' -%>>Lucro Real</option>
                    </select>
                </div>
                <div class="col-2">
                    <label for="inp_fornecedor">Fornecedor</label>
                    <select name="inp_fornecedor" id="inp_fornecedor" class="form-control">
                        <option value="0" <%- (cliente['classificacao']['fornecedor'] != '1')?'selected':'' -%>>Não</option>
                        <option value="1" <%- (cliente['classificacao']['fornecedor'] == '1')?'selected':'' -%>>Sim</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header bg-primary text-light">
            <strong>Dados Gerais</strong>
        </div>
        <div class="card-body">
            <div class="row mt-3">
                <div class="col">
                    <label for="inp_razaoSocial">Nome/Razão Social <small class="text-danger">*</small></label>
                    <input type="text" class="form-control" id="inp_razaoSocial" name="inp_razaoSocial" value="<%- cliente['razaoSocial'] -%>" required>
                </div>
                <div class="col">
                    <label for="inp_nomeFantasia">Nome Fantasia <small class="text-danger">*</small></label>
                    <input type="text" class="form-control" id="inp_nomeFantasia" name="inp_nomeFantasia" value="<%- cliente['nomeFantasia'] -%>" <%-PJ-%> required>
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                    <label for="inp_cpf">CPF <small class="text-danger">*</small></label>
                    <input type="text" name="inp_cpf" id="inp_cpf" class="form-control" value="<%- cliente['cpf'] -%>" <%-PF-%> required>
                </div>
                <div class="col">
                    <label for="inp_cnpj">CNPJ <small class="text-danger">*</small></label>
                    <input type="text" name="inp_cnpj" id="inp_cnpj" class="form-control" value="<%- cliente['cnpj'] -%>" <%-PJ-%> required>
                </div>
                <div class="col">
                    <label for="inp_ie">Inscrição Estadual <small class="text-danger">*</small></label>
                    <input type="text" name="inp_ie" id="inp_ie" class="form-control" value="<%- cliente['ie'] -%>" <%-PJ-%> <%-MEI-%> required>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header bg-primary text-light">
            <strong>Endereço</strong>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <div class="input-group">
                        <input type="text" id="inp_cep" class="form-control" placeholder="CEP">
                        <input type="text" id="inp_endereco" class="form-control w-25" placeholder="Endereço">
                        <input type="text" id="inp_complemento" class="form-control w-25" placeholder="Complemento">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-primary" id="btn_addEndereco">Adicionar</button>
                        </div>
                    </div> 
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>CEP</th>
                                <th>Endereco</th>
                                <th>Complemento</th>
                                <th>Padrão</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tbl_endereco">
                            <% if(cliente['endereco'])for(let i = 0; i < cliente['endereco'].length;i++){ %>
                                <tr>
                                    <td><input class="form-control" value="<%- cliente['endereco'][i]['cep'] -%>" disabled></td>
                                    <td><input class="form-control" value="<%- cliente['endereco'][i]['endereco'] -%>" disabled></td>
                                    <td><input class="form-control" value="<%- cliente['endereco'][i]['complemento'] -%>" disabled></td>
                                    <td><select class="form-control"><option value="0" <%- (cliente['endereco'][i]['padrao'] == '2')?'selected':'' -%>>Nao</option><option value="1" <%- (cliente['endereco'][i]['padrao'] == '1')?'selected':'' -%>>Sim</option></select></td>
                                    <td><button type="button" class="btn btn-danger" onclick="delThis(this)"><i class="fa-solid fa-trash-can"></i></button></td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header bg-primary text-light">
            <strong>Contato</strong>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col">
                    <div class="input-group">
                        <select id="inp_tipoContato" class="form-control">
                            <option value="celular">Celular</option>
                            <option value="telefone">Telefone</option>
                            <option value="email">Email</option>
                            <option value="site">Site</option>
                        </select>
                        <input type="text" id="inp_contato" class="form-control w-75" placeholder="Contato">
                        <div class="input-group-append">
                            <button type="button" class="btn btn-primary" id="btn_addContato">Adicionar</button>
                        </div>
                    </div> 
                </div>
            </div>
            <div class="row mt-3">
                <div class="col">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Contato</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="tbl_contato">
                            <% if(cliente['contato'])for(let i = 0; i < cliente['contato'].length;i++){ %>
                                <tr>
                                    <td><select class="form-control" disabled>
                                        <option value="celular" <%- (cliente['contato'][i]['tipo'] =='celular')?'selected':'' -%>>Celular</option>
                                        <option value="telefone" <%- (cliente['contato'][i]['tipo'] =='telefone')?'selected':'' -%>>Telefone</option>
                                        <option value="email" <%- (cliente['contato'][i]['tipo'] =='email')?'selected':'' -%>>Email</option>
                                        <option value="site" <%- (cliente['contato'][i]['tipo'] =='site')?'selected':'' -%>>Site</option>
                                    </select></td>
                                    <td><input type="text" value="<%- cliente['contato'][i]['contato']-%>" class="form-control" disabled></td>
                                    <td><button type="button" class="btn btn-danger" onclick="delThis(this)"><i class="fa-solid fa-trash-can"></i></button></td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!--
    <div class="card mt-3">
        <div class="card-header">
            <strong>Fiscal</strong>
        </div>
        <div class="card-body">
        </div>
    </div>
    -->

    <div class="card mt-3">
        <div class="card-header bg-primary text-light">
            <strong>Observações</strong>
        </div>
        <div class="card-body">
            <textarea name="inp_obs" id="inp_obs" class="form-control" rows="10"><%- cliente['obs'] -%></textarea>
        </div>
    </div>

    <div class="mt-3">
        <a href="/clientes" class="btn btn-secondary text-light">Voltar</a>
        <%- 
            (cliente['_id']!=undefined)?
            '<div id="btn_excluir" class="btn btn-danger text-light mr-1">Excluir</div><button type="submit" class="btn btn-primary text-light">Editar</button>':
            '<button type="submit" class="btn btn-primary text-light">Salvar</button>' 
        -%>
    </div>
</form>

<script>
    $('#inp_cpf').mask('999.999.999-99');
    $('#inp_cnpj').mask('99.999.999/9999-99');
    $("#inp_cep").mask('99.999-999');
    $('#inp_contato').mask('(54) 99999-9999');
    $("#inp_razaoSocial").focus();

    function toJson(){
        let contato = $("#tbl_contato tr");
        let endereco = $("#tbl_endereco tr");
        let resp = {
            razaoSocial:$('#inp_razaoSocial').val(),
            nomeFantasia:$('#inp_nomeFantasia').val(),
            cpf:$('#inp_cpf').val(),
            cnpj:$('#inp_cnpj').val(),
            ie:$('#inp_ie').val(),
            obs:$('#inp_obs').val(),
            classificacao:{
                pessoa:$('#inp_pessoa').val(),
                mei:$('#inp_mei').val(),
                enquadramento:$('#inp_enquadramento').val(),
                fornecedor: $('#inp_fornecedor').val(),
            },
            endereco:[],
            contato:[],
        };

        for(let i = 0;i < endereco.length;i++){
            let end = $(endereco[i]).find('input');
            resp.endereco.push({
                cep: $(end[0]).val(),
                endereco: $(end[1]).val(),
                complemento: $(end[2]).val(),
                padrao: $(endereco[i]).find('select').val()
            });
        }

        for(let i = 0;i < contato.length;i++){
            resp.contato.push({
                tipo: $(contato[i]).find('select').val(),
                contato: $(contato[i]).find('input').val()
            });
        }

        return JSON.stringify(resp);
    }

    function delThis(self){
        $(self).parent().parent().remove();
    }

    $('#form_cadastro').submit((e)=>{
        e.preventDefault();
        if($('#inp_id').val() == ""){
            socket.emit('addUsr',toJson());
        }
        else{
            Swal.fire({
                title:'Deseja salvar a edição?',
                showCancelButton: true,
                confirmButtonText: 'Salvar',
                cancelButtonText: 'Cancelar',
            }).then((resp)=>{
                if(resp.isConfirmed){
                    socket.emit('editUsr',{form:toJson(),id:$('#inp_id').val()});
                };
            });
        }
    });

    $("#btn_excluir").click(()=>{
        Swal.fire({
            icon:'warning',
            title: $('#inp_razaoSocial').val(),
            text:'Deseja Excluir?',
            showCancelButton: true,
            showConfirmButton: false,
            showDenyButton: true,
            denyButtonText: 'Excluir',
            cancelButtonText: 'Cancelar',
        }).then((resp)=>{
           if(resp.isDenied){
                socket.emit('delUsr',$('#inp_id').val());
            };
        });
    });

    $('#inp_pessoa').change(()=>{
        let val = $('#inp_pessoa option:selected').val();
        
        if(val == 2){
            $("#inp_mei").attr('disabled','');
            $("#inp_enquadramento").attr('disabled','');
            $("#inp_nomeFantasia").attr('disabled','');
            $("#inp_cnpj").attr('disabled','');
            $("#inp_ie").attr('disabled','');
            $("#inp_cpf").removeAttr('disabled');
        }
        else{
            $("#inp_mei").removeAttr('disabled','');
            $("#inp_enquadramento").removeAttr('disabled','');
            $("#inp_nomeFantasia").removeAttr('disabled','');
            $("#inp_cnpj").removeAttr('disabled','');
            $("#inp_ie").removeAttr('disabled','');
            $("#inp_cpf").attr('disabled','');
        }
    });

    $('#inp_mei').change(()=>{
        let val = $('#inp_mei option:selected').val();

        if(val == 1){
            $('#inp_enquadramento').attr('disabled','');
            $('#inp_ie').attr('disabled','');
        }
        else{
            $('#inp_enquadramento').removeAttr('disabled');
            $('#inp_ie').removeAttr('disabled');
        }
    });

    $('#inp_tipoContato').change(()=>{
        let val = $("#inp_tipoContato :selected").val();
        if(val == 'telefone' || val == 'celular'){
            $('#inp_contato').mask('(54) 99999-9999');
        }else{
            $('#inp_contato').unmask();
        }
    });

    $('#btn_addContato').click(()=>{
        $("#tbl_contato").append(`
        <tr>
            <td><select class="form-control" disabled>
                <option value="celular" `+(($('#inp_tipoContato').val()=='celular')?'selected':'')+`>Celular</option>
                <option value="telefone" `+(($('#inp_tipoContato').val()=='telefone')?'selected':'')+`>Telefone</option>
                <option value="email" `+(($('#inp_tipoContato').val()=='email')?'selected':'')+`>Email</option>
                <option value="site" `+(($('#inp_tipoContato').val()=='site')?'selected':'')+`>Site</option>
            </select></td>
            <td><input type="text" value="`+$("#inp_contato").val()+`" class="form-control" disabled></td>
            <td><button type="button" class="btn btn-danger" onclick="delThis(this)"><i class="fa-solid fa-trash-can"></i></button></td>
        </tr>
        `);
        $("#inp_contato").val('');
        $("#inp_contato").focus();
    });

    $('#btn_addEndereco').click(()=>{
        $("#tbl_endereco").append(`
        <tr>
            <td><input class="form-control" value="`+$('#inp_cep').val()+`" disabled></td>
            <td><input class="form-control" value="`+$('#inp_endereco').val()+`" disabled></td>
            <td><input class="form-control" value="`+$('#inp_complemento').val()+`" disabled></td>
            <td><select class="form-control"><option value="0">Nao</option><option value="1">Sim</option></select></td>
            <td><button type="button" class="btn btn-danger" onclick="delThis(this)"><i class="fa-solid fa-trash-can"></i></button></td>
        </tr>
        `);
        $("#inp_cep").val('');
        $("#inp_endereco").val('');
        $("#inp_complemento").val('');
        $("#inp_cep").focus();
    });

    socket.on('addUser-resp',(resp)=>{
        Swal.fire({
            icon:(resp['success'])?'success':'error',
            showConfirmButton: false,
            title:(resp['success'])?'Cliente salvo':resp['err'],
            timer: 1500
        }).then(()=>{if(resp['success']){location.href='/clientes'}});
    });
    socket.on('editUser-resp',(resp)=>{
        Swal.fire({
            icon:(resp['success'])?'success':'error',
            showConfirmButton: false,
            title:(resp['success'])?'Edição salva':resp['err'],
            timer: 1500
        }).then(()=>{if(resp['success']){location.href='/clientes'}});
    });
    socket.on('delUser-resp',(resp)=>{
        Swal.fire({
            icon:(resp['success'])?'success':'error',
            showConfirmButton: false,
            title:(resp['success'])?'Cliente excluido':resp['err'],
            timer: 1500
        }).then(()=>{if(resp['success']){location.href='/clientes'}});
    });
</script>

<%- include("../includes/footer.ejs"); %>